# æ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼å®ç°è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æŒ‰ç…§æä¾›çš„æ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†åç«¯æ¥å£è¿”å›å€¼æ ¼å¼å’Œå‰ç«¯æ¸²æŸ“ç»„ä»¶çš„å…¨é¢è°ƒæ•´ã€‚è¿™ä¸ªå®ç°æ”¯æŒå¤šç§å†…å®¹ç±»å‹çš„ç»Ÿä¸€å±•ç¤ºï¼Œä¸ºåç»­åŠŸèƒ½æ‰©å±•æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚

## ğŸ”§ **æ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼ç»“æ„**

### åŸºæœ¬æ ¼å¼
```json
{
  "message_id": "msg-20250617-001",
  "timestamp": "2025-06-17T15:00:00Z",
  "role": "assistant",
  "content": [
    {
      "type": "text|markdown|table|image|code|tool_call|file_link|link",
      "data": "å†…å®¹æ•°æ®"
    }
  ]
}
```

### æ”¯æŒçš„å†…å®¹ç±»å‹

#### 1. **æ–‡æœ¬å†…å®¹ (text)**
```json
{
  "type": "text",
  "data": "è¿™æ˜¯ä¸€æ®µæ™®é€šæ–‡æœ¬å†…å®¹"
}
```

#### 2. **Markdownå†…å®¹ (markdown)**
```json
{
  "type": "markdown", 
  "data": "## æ ‡é¢˜\n- åˆ—è¡¨é¡¹1\n- åˆ—è¡¨é¡¹2\n**ç²—ä½“æ–‡æœ¬**"
}
```

#### 3. **è¡¨æ ¼å†…å®¹ (table)**
```json
{
  "type": "table",
  "data": {
    "headers": ["æ–‡æ¡£", "ç›¸å…³åº¦", "å†…å®¹é¢„è§ˆ", "æ“ä½œ"],
    "rows": [
      ["åˆåŒ.pdf", "0.85", "ç§ŸèµåˆåŒå†…å®¹...", "ğŸ“„ é¢„è§ˆ"],
      ["æŠ¥å‘Š.docx", "0.72", "è´¢åŠ¡æŠ¥å‘Šæ‘˜è¦...", "ğŸ“„ é¢„è§ˆ"]
    ]
  }
}
```

#### 4. **å›¾ç‰‡å†…å®¹ (image)**
```json
{
  "type": "image",
  "data": {
    "url": "https://example.com/image.png",
    "alt": "å›¾ç‰‡æè¿°"
  }
}
```

#### 5. **ä»£ç å— (code)**
```json
{
  "type": "code",
  "data": {
    "language": "python",
    "content": "def hello():\n    print('Hello World')"
  }
}
```

#### 6. **å·¥å…·è°ƒç”¨ (tool_call)**
```json
{
  "type": "tool_call",
  "data": {
    "tool": "create_folder",
    "params": {
      "name": "æ–°æ–‡ä»¶å¤¹",
      "parent_id": 123
    },
    "result": "æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ",
    "user_visible": true
  }
}
```

#### 7. **æ–‡ä»¶é“¾æ¥ (file_link)**
```json
{
  "type": "file_link",
  "data": {
    "url": "/api/documents/123/preview",
    "filename": "é‡è¦æ–‡æ¡£.pdf",
    "description": "æŸ¥çœ‹æ–‡æ¡£è¯¦æƒ…"
  }
}
```

#### 8. **å¤–éƒ¨é“¾æ¥ (link)**
```json
{
  "type": "link",
  "data": {
    "url": "https://example.com",
    "title": "æŸ¥çœ‹æ›´å¤šä¿¡æ¯"
  }
}
```

## ğŸš€ **åç«¯å®ç°**

### 1. **æ¥å£å“åº”æ ¼å¼è°ƒæ•´**

åœ¨ `app/routes/search_routes.py` ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†è¯­ä¹‰æœç´¢å’Œæ··åˆæœç´¢æ¥å£ï¼š

```python
# æ„å»ºæ ‡å‡†åŒ–å“åº”æ ¼å¼
standardized_response = {
    "message_id": f"msg-{int(time.time())}-{hash(query_text) % 1000:03d}",
    "timestamp": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
    "role": "assistant",
    "content": message_content,
    # ä¿æŒåŸæœ‰æ•°æ®ç»“æ„ä»¥ç¡®ä¿å‘åå…¼å®¹
    "legacy_data": response_data
}

return jsonify({
    'success': True,
    'data': standardized_response
})
```

### 2. **å†…å®¹ç±»å‹ç”Ÿæˆé€»è¾‘**

æ ¹æ®ä¸åŒçš„æœç´¢ç»“æœï¼Œåç«¯ä¼šç”Ÿæˆç›¸åº”çš„å†…å®¹ç±»å‹ï¼š

- **æ„å›¾åˆ†æç»“æœ** â†’ `text` ç±»å‹
- **LLMç­”æ¡ˆ** â†’ `markdown` ç±»å‹  
- **MCPå·¥å…·æ‰§è¡Œ** â†’ `tool_call` ç±»å‹
- **æœç´¢ç»“æœ** â†’ `table` ç±»å‹
- **æ–‡ä»¶é“¾æ¥** â†’ `file_link` ç±»å‹
- **æœç´¢å»ºè®®** â†’ `markdown` ç±»å‹

### 3. **å‘åå…¼å®¹æ€§**

é€šè¿‡ `legacy_data` å­—æ®µä¿æŒåŸæœ‰æ•°æ®ç»“æ„ï¼Œç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ã€‚

## ğŸ¨ **å‰ç«¯å®ç°**

### 1. **æ¶ˆæ¯æ¸²æŸ“å™¨ (MessageRenderer)**

åˆ›å»ºäº† `app/static/js/message_components.js`ï¼ŒåŒ…å«ï¼š

```javascript
class MessageRenderer {
    static renderMessage(message) {
        // æ¸²æŸ“å®Œæ•´æ¶ˆæ¯
    }
    
    static renderContentItem(contentItem) {
        // æ ¹æ®ç±»å‹æ¸²æŸ“å•ä¸ªå†…å®¹é¡¹
        switch (contentItem.type) {
            case 'text': return this.renderText(contentItem.data);
            case 'markdown': return this.renderMarkdown(contentItem.data);
            case 'table': return this.renderTable(contentItem.data);
            // ... å…¶ä»–ç±»å‹
        }
    }
}
```

### 2. **æ ·å¼ç³»ç»Ÿ (CSS)**

åˆ›å»ºäº† `app/static/css/message_components.css`ï¼Œæä¾›ï¼š

- **æ¶ˆæ¯å®¹å™¨æ ·å¼**ï¼šåŒºåˆ†ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯
- **å†…å®¹ç±»å‹æ ·å¼**ï¼šæ¯ç§å†…å®¹ç±»å‹çš„ä¸“é—¨æ ·å¼
- **å“åº”å¼è®¾è®¡**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
- **åŠ¨ç”»æ•ˆæœ**ï¼šæ¶ˆæ¯å‡ºç°çš„æµç•…åŠ¨ç”»

### 3. **é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ**

ä¿®æ”¹äº† `addChatMessage()` å‡½æ•°ï¼š

```javascript
function addChatMessage(sender, content, isThinking = false) {
    // æ£€æµ‹æ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼
    if (content && typeof content === 'object' && content.content && Array.isArray(content.content)) {
        const messageElement = MessageRenderer.renderMessage(content);
        chatMessages.appendChild(messageElement);
        return content.message_id;
    }
    
    // å…¼å®¹åŸæœ‰æ ¼å¼
    // ... åŸæœ‰é€»è¾‘
}
```

## ğŸ“Š **å®é™…åº”ç”¨ç¤ºä¾‹**

### æœç´¢ç»“æœå±•ç¤º

å½“ç”¨æˆ·æœç´¢"ç§ŸèµåˆåŒ"æ—¶ï¼Œç³»ç»Ÿè¿”å›ï¼š

```json
{
  "message_id": "msg-1671234567-123",
  "timestamp": "2025-06-17T15:30:00Z", 
  "role": "assistant",
  "content": [
    {
      "type": "text",
      "data": "ğŸ¯ æ„å›¾è¯†åˆ«: ç”¨æˆ·æƒ³è¦æœç´¢æ–‡æ¡£å†…å®¹"
    },
    {
      "type": "markdown",
      "data": "## ğŸ“„ æœç´¢ç»“æœ\n\næ ¹æ®æ‚¨çš„æŸ¥è¯¢ï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹ç›¸å…³æ–‡æ¡£ï¼š"
    },
    {
      "type": "table",
      "data": {
        "headers": ["æ–‡æ¡£", "ç›¸å…³åº¦", "å†…å®¹é¢„è§ˆ", "æ“ä½œ"],
        "rows": [
          ["ç§ŸèµåˆåŒ_2024.pdf", "0.92", "ç”²æ–¹ï¼šABCå…¬å¸ï¼Œä¹™æ–¹ï¼šXYZå…¬å¸...", "ğŸ“„ é¢„è§ˆ"],
          ["æˆ¿å±‹ç§Ÿèµåè®®.docx", "0.78", "ç§ŸèµæœŸé™ï¼š2024å¹´1æœˆ1æ—¥è‡³...", "ğŸ“„ é¢„è§ˆ"]
        ]
      }
    },
    {
      "type": "file_link",
      "data": {
        "url": "/api/documents/123/preview",
        "filename": "ç§ŸèµåˆåŒ_2024.pdf",
        "description": "æŸ¥çœ‹å®Œæ•´åˆåŒå†…å®¹"
      }
    }
  ]
}
```

### MCPå·¥å…·æ‰§è¡Œ

å½“ç”¨æˆ·è¯´"åˆ›å»ºé¡¹ç›®æ–‡æ¡£æ–‡ä»¶å¤¹"æ—¶ï¼š

```json
{
  "message_id": "msg-1671234568-456",
  "timestamp": "2025-06-17T15:31:00Z",
  "role": "assistant", 
  "content": [
    {
      "type": "text",
      "data": "ğŸ¯ æ„å›¾è¯†åˆ«: æ£€æµ‹åˆ°æ–‡ä»¶å¤¹åˆ›å»ºæ“ä½œ"
    },
    {
      "type": "tool_call",
      "data": {
        "tool": "create_folder",
        "params": {
          "name": "é¡¹ç›®æ–‡æ¡£",
          "parent_id": null
        },
        "result": "æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ",
        "user_visible": true
      }
    },
    {
      "type": "markdown",
      "data": "âœ… **æ“ä½œå®Œæˆ**\n\nå·²æˆåŠŸåˆ›å»ºæ–‡ä»¶å¤¹ã€Œé¡¹ç›®æ–‡æ¡£ã€ï¼Œæ‚¨å¯ä»¥åœ¨æ–‡æ¡£æ ‘ä¸­æŸ¥çœ‹ã€‚"
    }
  ]
}
```

## ğŸ”„ **æ‰©å±•æ€§è®¾è®¡**

### 1. **æ–°å¢å†…å®¹ç±»å‹**

è¦æ·»åŠ æ–°çš„å†…å®¹ç±»å‹ï¼Œåªéœ€è¦ï¼š

1. åœ¨åç«¯ç”Ÿæˆç›¸åº”çš„å†…å®¹é¡¹
2. åœ¨ `MessageRenderer` ä¸­æ·»åŠ æ¸²æŸ“æ–¹æ³•
3. åœ¨CSSä¸­æ·»åŠ å¯¹åº”æ ·å¼

### 2. **è‡ªå®šä¹‰æ¸²æŸ“**

æ¯ä¸ªå†…å®¹ç±»å‹éƒ½æœ‰ç‹¬ç«‹çš„æ¸²æŸ“æ–¹æ³•ï¼Œå¯ä»¥è½»æ¾è‡ªå®šä¹‰ï¼š

```javascript
static renderCustomType(data) {
    const container = document.createElement('div');
    container.className = 'content-custom';
    // è‡ªå®šä¹‰æ¸²æŸ“é€»è¾‘
    return container;
}
```

### 3. **ä¸»é¢˜æ”¯æŒ**

CSSä½¿ç”¨äº†CSSå˜é‡å’Œç±»åçº¦å®šï¼Œä¾¿äºä¸»é¢˜åˆ‡æ¢å’Œæ ·å¼å®šåˆ¶ã€‚

## âœ… **ä¼˜åŠ¿æ€»ç»“**

1. **ç»Ÿä¸€æ€§**ï¼šæ‰€æœ‰æ¶ˆæ¯å†…å®¹ä½¿ç”¨ç»Ÿä¸€æ ¼å¼
2. **æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„å†…å®¹ç±»å‹
3. **å…¼å®¹æ€§**ï¼šä¿æŒå‘åå…¼å®¹
4. **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ç»„ä»¶åŒ–æ¶æ„
5. **ç”¨æˆ·ä½“éªŒ**ï¼šä¸°å¯Œçš„è§†è§‰å‘ˆç°
6. **å“åº”å¼**ï¼šé€‚é…å„ç§è®¾å¤‡å°ºå¯¸

è¿™ä¸ªæ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼ä¸ºç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„å†…å®¹å±•ç¤ºèƒ½åŠ›ï¼Œæ”¯æŒä»ç®€å•æ–‡æœ¬åˆ°å¤æ‚äº¤äº’çš„å„ç§åœºæ™¯ã€‚ 