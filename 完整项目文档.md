# 智能文档管理与语义检索系统 - 完整项目文档

## 目录

1. [系统概述](#系统概述)
2. [核心功能](#核心功能)
3. [技术架构](#技术架构)
4. [MCP功能说明](#mcp功能说明)
5. [LLM集成功能](#llm集成功能)
6. [系统配置优化](#系统配置优化)
7. [功能改进记录](#功能改进记录)
8. [扩展功能说明](#扩展功能说明)
9. [数据库设置](#数据库设置)
10. [部署指南](#部署指南)

---

## 系统概述

这是一个集成的智能文档管理和语义检索系统，专为高效的文档处理和智能搜索而设计。系统将文档管理、内容识别、向量化处理和语义搜索功能统一到一个页面中，提供流畅的用户体验。

### 主要特性

- **智能语义搜索**：使用AI技术理解用户意图
- **文档管理**：支持文件上传、文件夹管理、文档编辑
- **智能向量化**：多格式支持，内容识别，OCR文字识别
- **统一界面**：所有功能集成在一个页面
- **响应式设计**：适配各种屏幕尺寸
- **实时反馈**：操作状态和进度实时显示

---

## 核心功能

### 🔍 智能语义搜索

- **自然语言查询**：使用AI技术理解用户意图
- **相似度评分**：显示搜索结果的相关性得分
- **上下文定位**：精确定位文档中的相关内容
- **多文档检索**：跨多个文档进行语义搜索
- **可调阈值**：支持4个相关性等级
  - 高相关性 (≥60%)
  - 中等相关性 (≥30%) - 默认选项
  - 低相关性 (≥10%)
  - 显示所有结果

### 📁 文档管理

- **文件上传**：支持单文件和文件夹批量上传
- **文件夹管理**：创建文件夹层级结构
- **文档编辑**：修改文档名称和描述
- **文档删除**：安全删除文档和文件夹
- **文档预览**：查看文档详细信息

### 🤖 智能向量化

- **多格式支持**：PDF、Word、Excel、图像等
- **内容识别**：OCR文字识别，支持多种引擎
- **内容预览**：向量化前预览和编辑文本
- **参数调整**：自定义分块大小和重叠度
- **批量处理**：高效的批量文档向量化

### 📊 支持的文件格式

| 类型 | 扩展名 | 功能特性 |
|------|--------|----------|
| PDF | .pdf | 文本+图像提取、OCR识别 |
| Word | .doc, .docx | 文本、表格、图像处理 |
| Excel | .xls, .xlsx, .xlsm, .xlsb | 数据分析、模式识别 |
| 图像 | .jpg, .jpeg, .png, .gif, .bmp, .tiff, .webp, .svg | OCR文字识别、模式检测 |
| 文本 | .txt, .md, .html, .csv, .json, .py, .js, .css, .sql | 内容提取、编码检测 |
| 视频 | .mp4, .avi, .mov, .wmv 等 | 预留支持 |

---

## 技术架构

### 前端技术
- **Bootstrap 5**：响应式UI框架
- **原生JavaScript**：无额外框架依赖
- **模块化设计**：功能模块化组织

### 后端技术
- **Flask**：Python Web框架
- **SQLAlchemy**：数据库ORM
- **Milvus**：向量数据库
- **MinIO**：对象存储（可选）

### AI技术栈
- **多OCR引擎**：Tesseract、EasyOCR、PaddleOCR
- **文本向量化**：SentenceTransformers
- **语义搜索**：向量相似度匹配
- **内容识别**：多语言文字识别

---

## MCP功能说明

### 概述

MCP (Model Context Protocol) 是一个开放标准，允许AI助手与外部工具和数据源进行安全、受控的交互。在智能文档管理系统中，MCP功能可以让AI助手自动调用各种工具来帮助用户完成复杂任务。

### 支持的MCP服务器

1. **Playwright自动化** (`playwright`)
   - 网页自动化和浏览器操作
   - 支持导航、点击、填写表单、截图等操作
   - 适用于需要与网页交互的查询

2. **Web搜索** (`search`)
   - 互联网搜索和信息获取
   - 实时数据检索
   - 网页内容获取

3. **文件系统操作** (`filesystem`)
   - 文件和目录操作
   - 文件搜索和管理
   - 本地文件系统访问

4. **内存存储** (`memory`)
   - 对话上下文存储
   - 会话数据管理
   - 临时数据持久化

### 智能工具选择

系统会根据用户的查询内容自动分析并建议使用合适的工具：

- **网页操作关键词**：浏览、打开网页、访问、点击、填写、截图、网站、URL等
- **搜索关键词**：搜索、查找、查询、信息、最新、网上、互联网等
- **文件操作关键词**：文件、目录、保存、读取、创建等

### 配置说明

在 `config.env` 文件中配置MCP相关设置：

```env
# MCP主开关
ENABLE_MCP=true

# 各服务器开关
MCP_PLAYWRIGHT_ENABLED=true
MCP_FILESYSTEM_ENABLED=false
MCP_SEARCH_ENABLED=true
MCP_MEMORY_ENABLED=true

# 服务器路径（可自定义）
MCP_PLAYWRIGHT_SERVER_PATH=npx @modelcontextprotocol/server-playwright
MCP_FILESYSTEM_SERVER_PATH=npx @modelcontextprotocol/server-filesystem
MCP_SEARCH_SERVER_PATH=npx @modelcontextprotocol/server-search
MCP_MEMORY_SERVER_PATH=npx @modelcontextprotocol/server-memory

# 功能开关
MCP_ENABLE_WEB_AUTOMATION=true
MCP_ENABLE_FILE_OPERATIONS=false
MCP_ENABLE_WEB_SEARCH=true
MCP_ENABLE_MEMORY=true

# 性能设置
MCP_TIMEOUT=60
MCP_MAX_CONCURRENT_TOOLS=3
```

### 使用方法

1. **启用MCP功能**
   - 在 `config.env` 中设置 `ENABLE_MCP=true`
   - 启用需要的MCP服务器
   - 重启应用程序

2. **在智能检索中使用**
   - 打开智能检索对话界面
   - 勾选"启用MCP工具"选项（可选，支持自动检测）
   - 输入需要工具协助的查询

3. **支持的操作类型**

#### 文件夹创建
**示例查询**:
- "创建一个名为项目资料的文件夹"
- "新建文件夹测试目录"
- "在uploads下创建test文件夹"

#### 文件创建
**示例查询**:
- "创建一个说明.txt文件"
- "在文档目录下创建readme.md"
- "新建报告.doc文件"

#### 文档搜索
**示例查询**:
- "搜索包含API的文档"
- "查找标签为重要的文件"
- "检索项目相关的资料"

### MCP功能改进历程

#### 已解决的问题

1. **支持创建文件**（✅ 已解决）
   - 增强意图识别逻辑，支持文件扩展名识别
   - 自动为无扩展名的文件添加.txt后缀
   - 支持指定目录下创建文件

2. **自动刷新文档树**（✅ 已解决）
   - MCP服务返回 `action: 'refresh_tree'` 标记
   - 前端自动检测并刷新文档树
   - 延迟1秒刷新，提供用户反馈

3. **正确显示MCP执行结果**（✅ 已解决）
   - 优化结果处理逻辑
   - MCP结果和搜索结果分离显示
   - 避免误导性错误信息

4. **自动检测文件操作意图**（✅ 已解决）
   - 无需手动开启MCP开关
   - 自动识别创建文件/文件夹意图
   - 智能执行相应操作

5. **支持指定父目录创建**（✅ 已解决）
   - 解析"在XX下创建"语法
   - 自动选中父目录
   - 支持多层级目录结构

### API接口

- `GET /api/mcp/status` - 获取MCP服务状态
- `POST /api/mcp/servers/start` - 启动MCP服务器
- `POST /api/mcp/servers/stop` - 停止MCP服务器
- `GET /api/mcp/tools` - 获取可用工具列表
- `POST /api/mcp/tools/analyze` - 分析查询并建议工具
- `POST /api/mcp/tools/execute` - 执行工具调用
- `GET /api/mcp/history` - 获取工具调用历史
- `GET /api/mcp/config` - 获取MCP配置信息

### 安全考虑

1. **权限控制**：MCP服务器应该运行在受限的环境中
2. **输入验证**：所有工具参数都应该进行验证
3. **超时设置**：设置合理的超时时间防止长时间阻塞
4. **并发限制**：限制同时执行的工具数量
5. **日志记录**：记录所有工具调用以便审计

---

## LLM集成功能

### 功能概述

为智能检索助手新增了大语言模型(LLM)选择功能，支持多种主流LLM提供商，为用户提供更智能的文档检索体验。

### 支持的LLM提供商

#### 1. OpenAI GPT 系列
- **GPT-3.5 Turbo**: 性价比最高的选择
- **GPT-4**: 更强的理解和推理能力
- **GPT-4 Turbo**: 最新的大容量模型

#### 2. Anthropic Claude 系列
- **Claude 3 Haiku**: 快速响应模型
- **Claude 3 Sonnet**: 平衡性能模型
- **Claude 3 Opus**: 最强性能模型

#### 3. Ollama (本地部署)
- **Llama 2**: Meta开源大模型
- **Qwen 2**: 阿里巴巴通义千问
- **ChatGLM3**: 清华智谱GLM系列
- **Baichuan 2**: 百川智能大模型

#### 4. 智谱AI
- **GLM-4**: 最新一代模型
- **GLM-3 Turbo**: 快速版本

#### 5. DeepSeek
- **DeepSeek Chat**: 通用对话模型
- **DeepSeek Coder**: 专业代码模型
- **DeepSeek V3**: 最新版本模型

### 配置说明

在 `config.env` 中配置LLM相关设置：

```bash
# OpenAI配置
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1

# Claude配置
ANTHROPIC_API_KEY=sk-ant-your-claude-key

# Ollama配置 (本地部署)
OLLAMA_BASE_URL=http://localhost:11434

# 智谱AI配置
ZHIPU_API_KEY=your-zhipu-api-key

# DeepSeek配置
DEEPSEEK_API_KEY=your-deepseek-api-key
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 默认LLM设置
DEFAULT_LLM_PROVIDER=openai
DEFAULT_LLM_MODEL=gpt-3.5-turbo

# 功能开关
ENABLE_LLM_QUERY_OPTIMIZATION=true     # 查询优化
ENABLE_LLM_RESULT_RERANKING=true       # 结果重排序
ENABLE_LLM_ANSWER_GENERATION=false     # 答案生成

# 性能参数
LLM_TIMEOUT=30                         # 超时时间(秒)
LLM_MAX_CONTEXT_LENGTH=4000           # 最大上下文长度
LLM_RERANK_BATCH_SIZE=20              # 重排序批量大小
LLM_MAX_TOKENS=500                    # 最大生成token数
LLM_TEMPERATURE=0.7                   # 生成温度
```

### 功能特性

#### 1. 查询优化 (Query Optimization)
- **功能**: LLM分析用户查询意图，生成更适合向量检索的查询
- **场景**: 自然语言查询转换为检索友好的关键词
- **示例**: "关于合同的文档" → ["合同", "协议", "法律文件"]

#### 2. 结果重排序 (Result Reranking)
- **功能**: 使用LLM对初步检索结果进行语义相关性重排
- **场景**: 提高最相关结果的排序位置
- **优势**: 结合向量相似度和语义理解

#### 3. 答案生成 (Answer Generation)
- **功能**: 基于检索结果生成自然语言答案
- **场景**: 直接回答用户问题，无需浏览多个文档
- **状态**: 默认关闭，可通过配置启用

#### 4. 智能降级
- **自动检测**: 如果LLM服务不可用，自动降级到传统检索
- **错误处理**: 优雅处理API调用失败
- **性能保障**: 确保基础功能正常工作

### 前端界面

在智能检索助手界面的右上角，现在有两个下拉选择器：

1. **相关性要求**: 控制搜索结果的相似度阈值
2. **大语言模型**: 选择用于智能优化的LLM模型

### API接口

#### 获取可用模型
```bash
GET /api/config/llm-models
```

#### 增强搜索请求
```bash
POST /api/search/
```

请求示例：
```json
{
  "query": "合同管理相关文档",
  "top_k": 5,
  "similarity_level": "medium",
  "llm_model": "openai:gpt-3.5-turbo",
  "enable_llm": true
}
```

### 使用建议

#### 开发/测试环境
- 推荐: Ollama + Llama 2 (本地免费)
- 配置: 安装Ollama并拉取模型

#### 生产环境
- 推荐: OpenAI GPT-3.5 Turbo (性价比)
- 高质量需求: Claude 3 Sonnet
- 中文优化: 智谱GLM-4

### 注意事项

1. **API密钥安全**: 不要在代码中硬编码API密钥
2. **成本控制**: 监控API调用量和费用
3. **隐私保护**: 敏感文档内容可能发送到第三方API
4. **性能考虑**: LLM调用会增加响应时间

---

## 系统配置优化

### 硬编码配置优化

本次优化将系统中的硬编码值提取到配置文件中，提高了系统的灵活性和可维护性。

#### 1. 应用服务器配置

**修改文件**: `run.py`, `config.py`, `config.env`

**优化后**:
```python
from config import Config
host = Config.APP_HOST
port = Config.APP_PORT

app.run(
    host=host,
    port=port,
    debug=True
)
```

**配置项**:
```env
APP_HOST=0.0.0.0
APP_PORT=5001
```

#### 2. MCP服务配置

**优化内容**:
- 应用URL配置可调整
- 超时时间可配置
- 各种等待时间可调整
- 服务开关可控制

**配置项**:
```env
# 基础配置
MCP_ENABLED=true
MCP_TIMEOUT=30
MCP_MAX_CONCURRENT_TOOLS=3
MCP_APP_URL=http://localhost:5001

# Playwright配置
MCP_PLAYWRIGHT_ENABLED=true
MCP_ELEMENT_TIMEOUT=5000
MCP_MODAL_TIMEOUT=10000
MCP_WAIT_TIMEOUT=500

# 其他服务器配置
MCP_SEARCH_ENABLED=false
MCP_FILESYSTEM_ENABLED=false
```

#### 3. LLM服务配置

**配置项**:
```env
# 性能参数
LLM_TIMEOUT=30
LLM_MAX_CONTEXT_LENGTH=4000
LLM_RERANK_BATCH_SIZE=20
LLM_MAX_TOKENS=500
LLM_TEMPERATURE=0.7
```

### 配置结构

在 `config.py` 中新增了完整的配置结构：

```python
# 应用服务配置
APP_HOST = os.environ.get('APP_HOST') or '0.0.0.0'
APP_PORT = int(os.environ.get('APP_PORT') or 5001)

# MCP配置
MCP_CONFIG = {
    'enabled': os.environ.get('MCP_ENABLED', 'true').lower() == 'true',
    'timeout': int(os.environ.get('MCP_TIMEOUT') or 30),
    'max_concurrent_tools': int(os.environ.get('MCP_MAX_CONCURRENT_TOOLS') or 3),
    'app_url': os.environ.get('MCP_APP_URL') or f'http://localhost:{int(os.environ.get("APP_PORT") or 5001)}',
    'playwright': {
        'element_timeout': int(os.environ.get('MCP_ELEMENT_TIMEOUT') or 5000),
        'modal_timeout': int(os.environ.get('MCP_MODAL_TIMEOUT') or 10000),
        'wait_timeout': int(os.environ.get('MCP_WAIT_TIMEOUT') or 500),
    },
    'servers': {
        'playwright': {
            'enabled': os.environ.get('MCP_PLAYWRIGHT_ENABLED', 'true').lower() == 'true',
            # ... 其他配置
        }
    }
}
```

### 优化效果

1. **提高灵活性**: 可通过环境变量轻松修改配置
2. **增强可维护性**: 所有配置项集中管理
3. **支持多环境**: 开发、测试、生产环境配置分离

---

## 扩展功能说明

### TXT文件预览功能

#### 功能概述

为文档管理系统增加了对txt文件及其他文本格式文件的预览功能，支持多种文本文件格式的内容提取、编码检测和元数据分析。

#### 支持的文件格式

**基础文本格式**:
- `.txt`, `.text`, `.log`

**标记语言**:
- `.md`, `.markdown`, `.html`, `.htm`, `.xml`

**数据格式**:
- `.csv`, `.json`

**代码文件**:
- `.py`, `.js`, `.css`, `.sql`

#### API接口

1. **文本内容预览**
   ```
   GET /api/preview/text/<doc_id>
   ```

2. **原始文件预览**
   ```
   GET /api/preview/text/raw/<doc_id>
   ```

3. **文件元数据**
   ```
   GET /api/preview/metadata/<doc_id>
   ```

#### 核心功能特性

1. **智能编码检测**: 自动检测文件编码
2. **大文件处理**: 自动截断超长内容
3. **文件统计分析**: 行数、字数、字符数统计
4. **格式特定分析**: CSV、JSON、代码文件特殊处理

### 相似度阈值功能

#### 功能概述

为智能检索助手添加了用户可选择的相似度阈值功能，让用户可以根据需要调整搜索结果的相关性要求。

#### 功能特点

1. **用户界面**: 在智能检索对话界面的右上角添加了相似度设置选择器
2. **阈值选项**:
   - **高相关性** (≥60%)
   - **中等相关性** (≥30%) - 默认选项
   - **低相关性** (≥10%)
   - **显示所有** (显示所有结果)

#### 解决的问题

- 向量数据库中少量文档时的搜索质量问题
- 用户无法控制搜索结果相关性的问题
- 不相关内容也会被返回的问题

### 图片向量化兼容性修复

#### 问题描述

在使用图片向量化功能时出现版本兼容性问题：
```
EasyOCR识别失败: module 'PIL.Image' has no attribute 'ANTIALIAS'
```

#### 解决方案

在关键位置添加了兼容性修复代码：

```python
# 兼容性修复：为新版本Pillow添加ANTIALIAS别名
try:
    from PIL import Image
    if not hasattr(Image, 'ANTIALIAS'):
        Image.ANTIALIAS = Image.LANCZOS
except Exception:
    pass
```

#### 修复效果

- ✅ PIL.Image.ANTIALIAS 兼容性修复已应用
- ✅ EasyOCR 导入成功
- ✅ 图像识别服务初始化成功
- ✅ 支持多种OCR引擎和图片格式

---

## 数据库设置

### 数据库脚本整理

项目中的MySQL脚本已整理合并为一个完整的脚本文件：

#### 原始脚本文件
- `create_tables.sql` - 基础表结构创建脚本
- `add_vectorization_fields.sql` - 向量化字段添加脚本

#### 合并后的脚本
- `merged_database_setup.sql` - **完整的数据库设置脚本**

### 使用方法

#### 方法一：命令行执行
```bash
# 1. 创建数据库
mysql -h 192.168.16.199 -u root -p -e "CREATE DATABASE document_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 2. 执行脚本
mysql -h 192.168.16.199 -u root -p document_management < database/merged_database_setup.sql
```

#### 方法二：MySQL客户端执行
```sql
-- 1. 连接到MySQL
mysql -h 192.168.16.199 -u root -p

-- 2. 创建数据库
CREATE DATABASE document_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 3. 使用数据库
USE document_management;

-- 4. 执行脚本
source /path/to/database/merged_database_setup.sql;
```

### 脚本包含的内容

#### 数据表结构
1. `document_nodes` - 文档节点表（包含向量化字段）
2. `document_contents` - 文档内容表
3. `vector_records` - 向量化记录表
4. `tags` - 标签表
5. `document_tags` - 文档标签关联表
6. `system_configs` - 系统配置表

#### 默认数据
- 系统配置项（包含基础配置和向量化配置）
- 默认标签数据

#### 验证功能
- 表结构验证
- 配置数据确认
- 索引创建确认
- 执行状态报告

---

## 部署指南

### 环境要求

1. **Python依赖**:
   ```bash
   pip install -r requirements.txt
   pip install playwright
   ```

2. **浏览器安装**:
   ```bash
   playwright install chromium
   ```

3. **数据库**: MySQL 5.7+
4. **向量数据库**: Milvus 2.0+

### 快速开始

#### 1. 启动系统
```bash
python run.py
```

#### 2. 访问系统
打开浏览器访问：http://localhost:5001

#### 3. 配置环境变量

复制 `config.env` 文件并根据需要修改配置：

```env
# 应用配置
APP_HOST=0.0.0.0
APP_PORT=5001

# 数据库配置
DATABASE_URL=mysql+pymysql://user:password@host:port/database

# 向量数据库配置
MILVUS_HOST=localhost
MILVUS_PORT=19530

# LLM配置
OPENAI_API_KEY=your-api-key
ENABLE_LLM_QUERY_OPTIMIZATION=true

# MCP配置
MCP_ENABLED=true
MCP_PLAYWRIGHT_ENABLED=true
```

### 目录结构

```
DocManage/
├── app/
│   ├── __init__.py              # 应用初始化和路由
│   ├── models.py                # 数据模型
│   ├── routes/                  # API路由
│   │   ├── document_routes.py   # 文档管理API
│   │   ├── search_routes.py     # 搜索API
│   │   ├── upload_routes.py     # 上传API
│   │   ├── vectorize_routes.py  # 向量化API
│   │   └── mcp_routes.py        # MCP功能API
│   ├── services/                # 业务服务
│   │   ├── vectorization/       # 向量化服务
│   │   ├── image_recognition_service.py # 图像识别
│   │   ├── llm_service.py       # LLM服务
│   │   ├── mcp_service.py       # MCP服务
│   │   └── prompt_service.py    # 提示词服务
│   └── static/
│       ├── semantic_search.html # 主页面（集成界面）
│       └── js/
│           └── integrated_app.js # 前端逻辑
├── database/
│   └── merged_database_setup.sql # 数据库设置脚本
├── config.py                    # 配置文件
├── config.env                   # 环境变量配置
├── run.py                       # 启动文件
└── README.md                    # 系统说明
```

### API端点

- `GET /api/documents/tree` - 获取文档树
- `POST /api/upload/` - 上传文件
- `POST /api/search/` - 语义搜索
- `POST /api/vectorize/preview/{doc_id}` - 预览向量化
- `POST /api/vectorize/execute/{doc_id}` - 执行向量化
- `GET /api/preview/text/{doc_id}` - 文本预览
- `GET /api/mcp/status` - MCP服务状态
- `GET /api/config/llm-models` - 获取LLM模型列表

### 性能特性

- **响应式加载**：按需加载文档内容
- **增量搜索**：实时搜索结果更新
- **缓存优化**：智能缓存提升性能
- **并行处理**：支持并发向量化任务

### 安全特性

- **文件类型检查**：严格的文件格式验证
- **路径安全**：防止目录遍历攻击
- **输入验证**：全面的用户输入验证
- **错误处理**：安全的错误信息提示

### 使用技巧

#### 文档上传
- 支持拖拽上传，直接将文件拖到上传区域
- 文件夹上传会保持目录结构
- 批量上传支持显示上传进度

#### 搜索优化
- 使用自然语言描述要查找的内容
- 可以搜索概念性内容，不需要精确匹配
- 搜索结果按相关性排序，得分越高越相关

#### 向量化建议
- 大文档建议适当增加分块大小
- 有重要上下文关联的文档建议增加重叠度
- 图像文件会自动进行OCR识别

---

## 结语

智能文档管理与语义检索系统是一个功能完整、技术先进的文档管理解决方案。通过集成多种AI技术、支持多种文件格式、提供智能搜索和自动化操作能力，为用户提供了高效、便捷的文档管理体验。

系统采用模块化设计，具有良好的扩展性和可维护性，可以根据具体需求进行定制和扩展。无论是个人使用还是企业部署，都能满足不同场景下的文档管理需求。

**系统版本**: v2.0  
**最后更新**: 2025年6月  
**技术支持**: 集成智能文档管理系统