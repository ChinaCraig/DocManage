# æ™ºèƒ½æ£€ç´¢å¯¹è¯æ¥å£ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼é‡æ„å®Œæˆè¯´æ˜

## ğŸ¯ é‡æ„ç›®æ ‡

å°†æ™ºèƒ½æ£€ç´¢å¯¹è¯æ¥å£çš„è¿”å›æ ¼å¼ç»Ÿä¸€ä¸ºæ ‡å‡†åŒ–çš„JSONç»“æ„ï¼Œæ¨¡ä»¿ChatGPTå’ŒClaudeçš„è¿”å›æœºåˆ¶ï¼š
- **åç«¯ç»Ÿä¸€è¿”å›æ ¼å¼**ï¼šæ‰€æœ‰æ„å›¾ç±»å‹éƒ½è¿”å›ç›¸åŒçš„æ¶ˆæ¯ç»“æ„
- **å‰ç«¯æ™ºèƒ½æ¸²æŸ“**ï¼šæ ¹æ®å†…å®¹ç±»å‹ä½¿ç”¨ä¸åŒç»„ä»¶è¿›è¡Œæ¸²æŸ“
- **å‘åå…¼å®¹æ€§**ï¼šä¿æŒåŸæœ‰æ•°æ®ç»“æ„çš„å…¼å®¹æ€§

## ğŸ“‹ ç»Ÿä¸€è¿”å›æ ¼å¼

æ‰€æœ‰æ™ºèƒ½æ£€ç´¢è¯·æ±‚ç°åœ¨éƒ½è¿”å›ä»¥ä¸‹æ ‡å‡†åŒ–æ ¼å¼ï¼š

```json
{
  "success": true,
  "data": {
    "message_id": "msg-1703123456-123",
    "timestamp": "2025-06-17T12:00:00Z", 
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "data": "æ„å›¾è¯†åˆ«ä¿¡æ¯"
      },
      {
        "type": "markdown", 
        "data": "AIç”Ÿæˆçš„å›ç­”å†…å®¹"
      },
      {
        "type": "table",
        "data": {
          "headers": ["åˆ—å1", "åˆ—å2"],
          "rows": [["æ•°æ®1", "æ•°æ®2"]]
        }
      },
      {
        "type": "tool_call",
        "data": {
          "tool": "å·¥å…·åç§°",
          "params": {},
          "result": "æ‰§è¡Œç»“æœ",
          "user_visible": true
        }
      },
      {
        "type": "file_link",
        "data": {
          "url": "/api/documents/123/preview",
          "filename": "æ–‡æ¡£å.pdf", 
          "description": "æŸ¥çœ‹æ–‡æ¡£æè¿°"
        }
      }
    ],
    "legacy_data": {
      // åŸæœ‰æ ¼å¼æ•°æ®ï¼Œç¡®ä¿å‘åå…¼å®¹
    }
  }
}
```

## ğŸ­ æ”¯æŒçš„å†…å®¹ç±»å‹

### 1. æ–‡æœ¬ç±»å‹ (`text`)
```json
{
  "type": "text",
  "data": "çº¯æ–‡æœ¬å†…å®¹"
}
```

### 2. Markdownç±»å‹ (`markdown`)
```json
{
  "type": "markdown", 
  "data": "## æ ‡é¢˜\n- åˆ—è¡¨é¡¹\n**ç²—ä½“æ–‡æœ¬**"
}
```

### 3. è¡¨æ ¼ç±»å‹ (`table`)
```json
{
  "type": "table",
  "data": {
    "headers": ["æ–‡æ¡£", "ç›¸å…³åº¦", "ç±»å‹"],
    "rows": [
      ["æ–‡æ¡£1.pdf", "0.95", "PDF"],
      ["æ–‡æ¡£2.docx", "0.87", "Word"]
    ]
  }
}
```

### 4. å›¾ç‰‡ç±»å‹ (`image`)
```json
{
  "type": "image",
  "data": {
    "url": "https://example.com/image.png",
    "alt": "å›¾ç‰‡æè¿°"
  }
}
```

### 5. ä»£ç å—ç±»å‹ (`code`)
```json
{
  "type": "code",
  "data": {
    "language": "python",
    "content": "def hello():\n    print('Hello World')"
  }
}
```

### 6. å·¥å…·è°ƒç”¨ç±»å‹ (`tool_call`)
```json
{
  "type": "tool_call",
  "data": {
    "tool": "create_folder_api",
    "params": {
      "name": "æ–°æ–‡ä»¶å¤¹",
      "parent_id": 123
    },
    "result": "æˆåŠŸåˆ›å»ºæ–‡ä»¶å¤¹",
    "user_visible": true
  }
}
```

### 7. æ–‡ä»¶é“¾æ¥ç±»å‹ (`file_link`)
```json
{
  "type": "file_link",
  "data": {
    "url": "/api/documents/123/preview",
    "filename": "æŠ¥å‘Š.pdf",
    "description": "ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
  }
}
```

### 8. æ™®é€šé“¾æ¥ç±»å‹ (`link`)
```json
{
  "type": "link",
  "data": {
    "url": "https://example.com",
    "title": "å¤–éƒ¨é“¾æ¥"
  }
}
```

## ğŸ”„ ä¸‰ç§æ„å›¾ç±»å‹å¤„ç†

### 1. æ™®é€šèŠå¤© (normal_chat)
**ç‰¹ç‚¹**ï¼šç›´æ¥LLMé—®ç­”ï¼Œæ— éœ€æ–‡æ¡£æ£€ç´¢
**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "content": [
    {
      "type": "text",
      "data": "ğŸ’¬ æ™®é€šå¯¹è¯: ç”¨æˆ·è¯¢é—®é€šç”¨ä¿¡æ¯ï¼Œå±äºæ—¥å¸¸å¯¹è¯äº¤æµ"
    },
    {
      "type": "markdown", 
      "data": "æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹å»ºè®®..."
    }
  ]
}
```

### 2. çŸ¥è¯†åº“æ£€ç´¢ (knowledge_search)
**ç‰¹ç‚¹**ï¼šåŸºäºæ–‡æ¡£å†…å®¹æ£€ç´¢+LLMæ±‡æ€»
**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "content": [
    {
      "type": "text",
      "data": "ğŸ¯ æ„å›¾è¯†åˆ«: ç”¨æˆ·è¦æ±‚æŸ¥æ‰¾ç‰¹å®šå†…å®¹ï¼Œéœ€è¦åœ¨æ–‡æ¡£ä¸­æœç´¢"
    },
    {
      "type": "markdown",
      "data": "æ ¹æ®æ–‡æ¡£å†…å®¹åˆ†æï¼Œæ‰¾åˆ°ä»¥ä¸‹ç›¸å…³ä¿¡æ¯..."
    },
    {
      "type": "table",
      "data": {
        "headers": ["æ–‡æ¡£", "ç›¸å…³åº¦", "å†…å®¹é¢„è§ˆ"],
        "rows": [["æ–‡æ¡£1.pdf", "0.95", "ç›¸å…³å†…å®¹ç‰‡æ®µ..."]]
      }
    },
    {
      "type": "file_link",
      "data": {
        "url": "/api/documents/123/preview",
        "filename": "ç›¸å…³æ–‡æ¡£.pdf",
        "description": "æŸ¥çœ‹å®Œæ•´æ–‡æ¡£"
      }
    }
  ]
}
```

### 3. MCPæ“ä½œ (mcp_action)
**ç‰¹ç‚¹**ï¼šæ‰§è¡Œæ–‡ä»¶/æ–‡ä»¶å¤¹åˆ›å»ºç­‰æ“ä½œ
**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "content": [
    {
      "type": "text",
      "data": "ğŸ¯ è¯†åˆ«ä¸ºMCPæ“ä½œ: ç”¨æˆ·è¦æ±‚åˆ›å»ºæ–‡ä»¶å¤¹"
    },
    {
      "type": "tool_call",
      "data": {
        "tool": "create_folder_api",
        "params": {
          "name": "æ–°æ–‡ä»¶å¤¹",
          "parent": "çˆ¶ç›®å½•"
        },
        "result": "âœ… æˆåŠŸåˆ›å»ºæ–‡ä»¶å¤¹ 'æ–°æ–‡ä»¶å¤¹'",
        "user_visible": true
      }
    }
  ]
}
```

## ğŸ¨ å‰ç«¯æ¸²æŸ“æœºåˆ¶

### 1. ç»Ÿä¸€æ¸²æŸ“å™¨ (MessageRenderer)
ä½ç½®ï¼š`app/static/js/message_components.js`

æä¾› `MessageRenderer.renderMessage(message)` æ–¹æ³•ï¼Œè‡ªåŠ¨æ ¹æ®å†…å®¹ç±»å‹é€‰æ‹©åˆé€‚çš„æ¸²æŸ“ç»„ä»¶ã€‚

### 2. ç»„ä»¶åŒ–æ¸²æŸ“
æ¯ç§å†…å®¹ç±»å‹éƒ½æœ‰å¯¹åº”çš„æ¸²æŸ“æ–¹æ³•ï¼š
- `renderText()` - æ–‡æœ¬æ¸²æŸ“
- `renderMarkdown()` - Markdownæ¸²æŸ“
- `renderTable()` - è¡¨æ ¼æ¸²æŸ“
- `renderToolCall()` - å·¥å…·è°ƒç”¨æ¸²æŸ“
- `renderFileLink()` - æ–‡ä»¶é“¾æ¥æ¸²æŸ“
- ç­‰ç­‰...

### 3. æ ·å¼ç³»ç»Ÿ
ä½ç½®ï¼š`app/static/css/message_components.css`

æä¾›å®Œæ•´çš„æ ·å¼æ”¯æŒï¼š
- æ¶ˆæ¯å®¹å™¨å¸ƒå±€
- æ„å›¾è¯†åˆ«æ ‡è¯†
- å„ç§å†…å®¹ç±»å‹çš„ä¸“é—¨æ ·å¼
- å“åº”å¼è®¾è®¡
- åŠ¨ç”»æ•ˆæœ

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### åç«¯æ”¹åŠ¨
1. **è·¯ç”±å±‚** (`app/routes/search_routes.py`)
   - ç»Ÿä¸€æ‰€æœ‰æ„å›¾ç±»å‹çš„è¿”å›æ ¼å¼
   - æ·»åŠ æ ‡å‡†åŒ–æ¶ˆæ¯å†…å®¹æ„å»ºé€»è¾‘
   - ä¿æŒ `legacy_data` ç¡®ä¿å‘åå…¼å®¹

2. **é”™è¯¯å¤„ç†**
   - ä¿®å¤MCPæœåŠ¡è¿”å›çš„dataclasså¯¹è±¡å¤„ç†
   - ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ ¼å¼

### å‰ç«¯æ”¹åŠ¨
1. **æ¶ˆæ¯å¤„ç†** (`app/static/js/integrated_app.js`)
   - æ·»åŠ  `handleStandardizedMessage()` å‡½æ•°
   - ä¿æŒå‘åå…¼å®¹çš„å¤„ç†é€»è¾‘
   - æ™ºèƒ½æ£€æµ‹æ–°æ—§æ ¼å¼

2. **æ¸²æŸ“ç»„ä»¶** (`app/static/js/message_components.js`)
   - å…¨æ–°çš„ `MessageRenderer` ç±»
   - æ”¯æŒ8ç§å†…å®¹ç±»å‹
   - å¯æ‰©å±•çš„ç»„ä»¶æ¶æ„

3. **æ ·å¼ç³»ç»Ÿ** (`app/static/css/message_components.css`)
   - å®Œæ•´çš„è§†è§‰è®¾è®¡ç³»ç»Ÿ
   - æ„å›¾ç±»å‹å¯è§†åŒ–
   - å“åº”å¼å¸ƒå±€

## âœ… æµ‹è¯•éªŒè¯

### 1. æ™®é€šèŠå¤©æµ‹è¯•
```bash
curl -X POST http://localhost:5001/api/search/ \
  -H "Content-Type: application/json" \
  -d '{"query":"ä½ å¥½è¯·é—®å¤©æ°”æ€ä¹ˆæ ·","enable_mcp":true,"llm_model":"deepseek:deepseek-chat"}'
```

**è¿”å›**ï¼šæ ‡å‡†åŒ–æ ¼å¼ï¼ŒåŒ…å«æ„å›¾è¯†åˆ«å’ŒèŠå¤©å›ç­”

### 2. çŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•  
```bash
curl -X POST http://localhost:5001/api/search/ \
  -H "Content-Type: application/json" \
  -d '{"query":"å¸®æˆ‘æ‰¾åˆ°å’Œæ›¾å‹‡ç›¸å…³çš„æ‰€æœ‰å†…å®¹","enable_mcp":true,"llm_model":"deepseek:deepseek-chat"}'
```

**è¿”å›**ï¼šæ ‡å‡†åŒ–æ ¼å¼ï¼ŒåŒ…å«æœç´¢ç»“æœè¡¨æ ¼å’Œæ–‡ä»¶é“¾æ¥

### 3. MCPæ“ä½œæµ‹è¯•
```bash
curl -X POST http://localhost:5001/api/search/ \
  -H "Content-Type: application/json" \
  -d '{"query":"å¸®æˆ‘åœ¨test3æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªtest6æ–‡ä»¶å¤¹","enable_mcp":true,"llm_model":"deepseek:deepseek-chat"}'
```

**è¿”å›**ï¼šæ ‡å‡†åŒ–æ ¼å¼ï¼ŒåŒ…å«å·¥å…·è°ƒç”¨ç»“æœ

## ğŸš€ æ‰©å±•æ€§

### 1. æ–°å¢å†…å®¹ç±»å‹
åªéœ€åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ æ–°çš„ç±»å‹ï¼š
- `MessageRenderer.renderContentItem()` - æ·»åŠ æ–°çš„case
- å¯¹åº”çš„æ¸²æŸ“æ–¹æ³• - å®ç°å…·ä½“æ¸²æŸ“é€»è¾‘
- CSSæ ·å¼ - æ·»åŠ æ–°ç±»å‹çš„æ ·å¼

### 2. æ–°å¢æ„å›¾ç±»å‹
åœ¨åç«¯ `search_routes.py` ä¸­æ·»åŠ æ–°çš„æ„å›¾å¤„ç†é€»è¾‘ï¼Œè‡ªåŠ¨äº«å—ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ã€‚

### 3. è‡ªå®šä¹‰æ¸²æŸ“
å‰ç«¯å¯ä»¥é€šè¿‡ç»§æ‰¿æˆ–ä¿®æ”¹ `MessageRenderer` æ¥è‡ªå®šä¹‰ç‰¹å®šå†…å®¹ç±»å‹çš„æ¸²æŸ“æ•ˆæœã€‚

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å¹¶è¡Œæ¸²æŸ“**ï¼šå¤šä¸ªå†…å®¹ç»„ä»¶å¯ä»¥å¹¶è¡Œæ¸²æŸ“
2. **æ‡’åŠ è½½**ï¼šå›¾ç‰‡ç­‰èµ„æºé‡‡ç”¨æ‡’åŠ è½½ç­–ç•¥
3. **ç¼“å­˜æœºåˆ¶**ï¼šæ¸²æŸ“ç»“æœå¯ä»¥ç¼“å­˜å¤ç”¨
4. **é™çº§æœºåˆ¶**ï¼šå½“ç»„ä»¶åº“æœªåŠ è½½æ—¶è‡ªåŠ¨é™çº§åˆ°åŸºç¡€æ¸²æŸ“

## ğŸ‰ æ€»ç»“

æ­¤æ¬¡é‡æ„æˆåŠŸå®ç°äº†ï¼š

âœ… **ç»Ÿä¸€åç«¯æ ¼å¼**ï¼šæ‰€æœ‰æ„å›¾ç±»å‹è¿”å›æ ‡å‡†åŒ–JSONç»“æ„  
âœ… **ç»„ä»¶åŒ–å‰ç«¯**ï¼šå¯æ‰©å±•çš„æ¸²æŸ“ç»„ä»¶ç³»ç»Ÿ  
âœ… **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ  
âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ›´æ¸…æ™°çš„æ„å›¾å¯è§†åŒ–å’Œå†…å®¹å±•ç¤º  
âœ… **å¼€å‘æ•ˆç‡**ï¼šæ¨¡å—åŒ–è®¾è®¡ä¾¿äºç»´æŠ¤å’Œæ‰©å±•  
âœ… **ChatGPTå¼ä½“éªŒ**ï¼šç»Ÿä¸€æ–‡æœ¬è¾“å‡º+æ™ºèƒ½å‰ç«¯è§£é‡Šæ¸²æŸ“

è¯¥é‡æ„ä¸ºæœªæ¥åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ï¼ŒåŒæ—¶æä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œå¼€å‘ä½“éªŒã€‚ 