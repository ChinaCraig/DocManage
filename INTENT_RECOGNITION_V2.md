# æ„å›¾è¯†åˆ«ç³»ç»Ÿ v2.0 é‡æ„è¯´æ˜

## æ¦‚è¿°

æœ¬æ¬¡é‡æ„å®Œå…¨é‡æ–°è®¾è®¡äº†é¡¹ç›®çš„æ„å›¾è¯†åˆ«åŠŸèƒ½ï¼Œé‡‡ç”¨**LLMä¸»è¦åˆ†æ + å…³é”®è¯é™çº§åˆ†æ**çš„åŒå±‚æ¶æ„ï¼Œæä¾›æ›´å¯é ã€æ›´çµæ´»çš„æ„å›¾è¯†åˆ«èƒ½åŠ›ã€‚

## ğŸ¯ é‡æ„ç›®æ ‡

âœ… **ä¸æ”¹å˜ç°æœ‰æ¥å£çš„å…¥å‚å’Œè¿”å‚**ï¼Œåªè°ƒæ•´å†…éƒ¨é€»è¾‘  
âœ… **æ”¯æŒå¤šç§LLMæä¾›å•†**ï¼ˆDeepSeek/è±†åŒ…/æ™ºè°±AIç­‰ï¼‰  
âœ… **æ™ºèƒ½é™çº§å¤„ç†æœºåˆ¶**ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§  
âœ… **ç»Ÿä¸€é…ç½®ç®¡ç†**ï¼Œä¾¿äºè¿ç»´å’Œæ‰©å±•  
âœ… **å®Œå…¨æ›¿æ¢æ—§å®ç°**ï¼Œæ— å…¼å®¹åŒ…è¢±  

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒç»„ä»¶

```
æ„å›¾è¯†åˆ«ç³»ç»Ÿ v2.0
â”œâ”€â”€ é…ç½®å±‚ (intent_config.yaml)
â”‚   â”œâ”€â”€ LLMæä¾›å•†é…ç½®
â”‚   â”œâ”€â”€ æ„å›¾è¯†åˆ«æç¤ºè¯
â”‚   â”œâ”€â”€ é™çº§å¤„ç†é…ç½®  
â”‚   â””â”€â”€ å…³é”®è¯åˆ†æé…ç½®
â”œâ”€â”€ æœåŠ¡å±‚ (IntentRecognitionService)
â”‚   â”œâ”€â”€ LLMä¸»è¦åˆ†æ
â”‚   â”œâ”€â”€ å…³é”®è¯é™çº§åˆ†æ
â”‚   â”œâ”€â”€ ç»“æœç¼“å­˜
â”‚   â””â”€â”€ é”™è¯¯å¤„ç†
â””â”€â”€ æ¥å£å±‚ (analyze_user_intent)
    â””â”€â”€ å…¼å®¹åŸæœ‰æ¥å£
```

### 2. å¤„ç†æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æŸ¥è¯¢] --> B[æ£€æŸ¥ç¼“å­˜]
    B -->|ç¼“å­˜å‘½ä¸­| C[è¿”å›ç¼“å­˜ç»“æœ]
    B -->|ç¼“å­˜æœªå‘½ä¸­| D[LLMæ„å›¾åˆ†æ]
    D -->|æˆåŠŸ| E[æ£€æŸ¥ç½®ä¿¡åº¦]
    D -->|å¤±è´¥| F[é™çº§å¤„ç†]
    E -->|ç½®ä¿¡åº¦>=é˜ˆå€¼| G[è¿”å›LLMç»“æœ]
    E -->|ç½®ä¿¡åº¦<é˜ˆå€¼| F[é™çº§å¤„ç†]
    F --> H[å…³é”®è¯åˆ†æ]
    H --> I[ä¸Šä¸‹æ–‡å¢å¼º]
    I --> J[æ–‡ä»¶ç±»å‹æ£€æµ‹]
    J --> K[è¿”å›é™çº§ç»“æœ]
    G --> L[ç¼“å­˜ç»“æœ]
    K --> L[ç¼“å­˜ç»“æœ]
    L --> M[è®°å½•æŒ‡æ ‡]
```

## ğŸ“‹ é…ç½®æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒé…ç½® (intent_config.yaml)

```yaml
# LLMé…ç½®
llm_config:
  service_mode: "remote"  # remote | local
  current_provider: "deepseek"  # deepseek | doubao | zhipu
  current_model: "deepseek-chat"
  providers:
    deepseek:
      enabled: true
      api_key_env: "DEEPSEEK_API_KEY"
      base_url: "https://api.deepseek.com"
      models: ["deepseek-chat", "deepseek-v3"]
    doubao:
      enabled: true  
      api_key_env: "DOUBAO_API_KEY"
      base_url: "https://ark.cn-beijing.volces.com"
      models: ["doubao-pro-4k", "doubao-lite-4k"]

# æ„å›¾è¯†åˆ«æç¤ºè¯
intent_prompts:
  system_prompt: |
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”¨æˆ·æ„å›¾è¯†åˆ«ä¸“å®¶...
  user_prompt_template: |
    è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·è¾“å…¥çš„æ„å›¾ï¼š
    ç”¨æˆ·è¾“å…¥ï¼š"{query}"
  confidence_threshold: 0.6

# é™çº§å¤„ç†é…ç½®
fallback_config:
  enabled: true
  strategy: "keyword_analysis"  # keyword_analysis | fixed_response | hybrid
  default_intent: "knowledge_search"
  
# å…³é”®è¯åˆ†æé…ç½®
keyword_analysis:
  enabled: true
  weights:
    exact_match: 1.0
    partial_match: 0.7
  intent_keywords:
    normal_chat:
      primary: [["ä»€ä¹ˆæ˜¯", "å¦‚ä½•", "ä¸ºä»€ä¹ˆ"]]
      confidence_base: 0.7
    knowledge_search:
      primary: [["æŸ¥æ‰¾", "æœç´¢", "åˆ†æ"]]
      confidence_base: 0.8
    mcp_action:
      primary: [["åˆ›å»º", "æ–°å»º", "å»ºç«‹"]]
      confidence_base: 0.9
```

## ğŸ”§ ä¸»è¦åŠŸèƒ½ç‰¹æ€§

### 1. å¤šLLMæä¾›å•†æ”¯æŒ

- **DeepSeek**: é«˜æ€§ä»·æ¯”ï¼Œæ¨ç†èƒ½åŠ›å¼º
- **è±†åŒ…**: å­—èŠ‚è·³åŠ¨ï¼Œä¸­æ–‡ç†è§£ä¼˜ç§€  
- **æ™ºè°±AI**: GLMç³»åˆ—ï¼Œä»£ç ç”Ÿæˆèƒ½åŠ›å¼º
- **OpenAI**: GPTç³»åˆ—ï¼ˆå¤‡ç”¨ï¼‰
- **Ollama**: æœ¬åœ°éƒ¨ç½²é€‰é¡¹

### 2. æ™ºèƒ½é™çº§æœºåˆ¶

| è§¦å‘æ¡ä»¶ | é™çº§ç­–ç•¥ | æè¿° |
|---------|---------|------|
| LLM APIå¤±è´¥ | å…³é”®è¯åˆ†æ | ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡ä¸å¯ç”¨ |
| JSONè§£æå¤±è´¥ | å…³é”®è¯åˆ†æ | LLMè¿”å›æ ¼å¼é”™è¯¯ |
| ç½®ä¿¡åº¦è¿‡ä½ | å…³é”®è¯åˆ†æ | æ„å›¾è¯†åˆ«ä¸ç¡®å®š |
| è¯·æ±‚è¶…æ—¶ | å…³é”®è¯åˆ†æ | å“åº”æ—¶é—´è¿‡é•¿ |

### 3. å…³é”®è¯åˆ†æå¢å¼º

- **å¤šå±‚å…³é”®è¯åŒ¹é…**: ä¸»è¦å…³é”®è¯ + æ¬¡è¦å…³é”®è¯
- **ä¸Šä¸‹æ–‡è§„åˆ™**: åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„ä¸Šä¸‹æ–‡å¢å¼º
- **æ–‡ä»¶ç±»å‹æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶æ‰©å±•å
- **æƒé‡é…ç½®**: çµæ´»çš„åŒ¹é…æƒé‡è®¾ç½®

### 4. ç»“æœç¼“å­˜ä¼˜åŒ–

- **å†…å­˜ç¼“å­˜**: å¿«é€Ÿå“åº”é‡å¤æŸ¥è¯¢
- **TTLæœºåˆ¶**: å¯é…ç½®çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
- **LRUæ·˜æ±°**: è‡ªåŠ¨ç®¡ç†ç¼“å­˜å®¹é‡

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```python
from app.services.llm_service import LLMService

# åˆ†æç”¨æˆ·æ„å›¾ï¼ˆæ¥å£ä¿æŒä¸å˜ï¼‰
result = LLMService.analyze_user_intent("åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶")

print(result)
# {
#   "intent_type": "mcp_action",
#   "confidence": 0.9,
#   "action_type": "create_file", 
#   "parameters": {"file_name": null},
#   "reasoning": "æ£€æµ‹åˆ°åˆ›å»ºå’Œæ–‡ä»¶å…³é”®è¯",
#   "analysis_method": "llm",  # æ–°å¢å­—æ®µ
#   "model_used": "deepseek:deepseek-chat",
#   "timestamp": "2024-01-01T12:00:00"
# }
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# DeepSeeké…ç½®
export DEEPSEEK_API_KEY="your_deepseek_api_key"

# è±†åŒ…é…ç½®  
export DOUBAO_API_KEY="your_doubao_api_key"

# æ™ºè°±AIé…ç½®
export ZHIPU_API_KEY="your_zhipu_api_key"
```

### 3. è¿è¡Œæµ‹è¯•

```bash
python test_intent_recognition.py
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### 1. åˆ†ææŒ‡æ ‡

- **å“åº”æ—¶é—´**: LLMè°ƒç”¨å’Œæ€»å¤„ç†æ—¶é—´
- **ç½®ä¿¡åº¦åˆ†å¸ƒ**: æ„å›¾è¯†åˆ«çš„å‡†ç¡®æ€§è¯„ä¼°
- **é™çº§ç‡**: ç³»ç»Ÿç¨³å®šæ€§æŒ‡æ ‡
- **é”™è¯¯ç‡**: å¼‚å¸¸æƒ…å†µç»Ÿè®¡

### 2. æ—¥å¿—è®°å½•

```python
logger.info(f"æ„å›¾åˆ†æå®Œæˆ - æŸ¥è¯¢: {query[:50]}, "
           f"æ„å›¾: {result.get('intent_type')}, "
           f"ç½®ä¿¡åº¦: {result.get('confidence'):.3f}, "
           f"æ–¹æ³•: {result.get('analysis_method')}")
```

## ğŸ”„ è¿ç§»è¯´æ˜

### åˆ é™¤çš„æ—§æ–‡ä»¶

- âŒ `app/services/intent_prompt_service.py`
- âŒ `prompts/intent_analysis_prompts.yaml`

### æ–°å¢çš„æ–‡ä»¶

- âœ… `app/services/intent_service.py`
- âœ… `prompts/intent_config.yaml`
- âœ… `test_intent_recognition.py`

### æ¥å£å…¼å®¹æ€§

| å‡½æ•° | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `LLMService.analyze_user_intent()` | âœ… å…¼å®¹ | å…¥å‚å‡ºå‚å®Œå…¨ä¸å˜ |
| `intent_routes.py` | âœ… æ›´æ–° | ä½¿ç”¨æ–°æœåŠ¡ï¼Œæ¥å£å…¼å®¹ |

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. å¸¸è§é—®é¢˜

**Q: é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥**
```
A: æ£€æŸ¥ prompts/intent_config.yaml æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
```

**Q: LLMè°ƒç”¨å¤±è´¥**
```
A: 1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®è®¾ç½®
   2. æ£€æŸ¥ç½‘ç»œè¿æ¥
   3. æŸ¥çœ‹æ˜¯å¦è§¦å‘é™çº§å¤„ç†
```

**Q: æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ä½**
```
A: 1. è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼
   2. ä¼˜åŒ–å…³é”®è¯é…ç½®
   3. æ£€æŸ¥æç¤ºè¯è®¾ç½®
```

### 2. è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```python
import logging
logging.getLogger('app.services.intent_service').setLevel(logging.DEBUG)
```

## ğŸ‰ æ€»ç»“

æ–°çš„æ„å›¾è¯†åˆ«ç³»ç»Ÿ v2.0 å®ç°äº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

1. **æ¶æ„å‡çº§**: åŒå±‚å¤„ç†æ¶æ„ï¼Œæé«˜å¯é æ€§
2. **é…ç½®ç»Ÿä¸€**: é›†ä¸­å¼é…ç½®ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
3. **æ¨¡å‹æ‰©å±•**: æ”¯æŒå¤šç§LLMæä¾›å•†ï¼Œçµæ´»é€‰æ‹©
4. **é™çº§ä¿éšœ**: æ™ºèƒ½é™çº§æœºåˆ¶ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨
5. **æ€§èƒ½ä¼˜åŒ–**: ç»“æœç¼“å­˜å’ŒæŒ‡æ ‡ç›‘æ§
6. **å®Œå…¨æ›¿æ¢**: åˆ é™¤æ—§ä»£ç ï¼Œæ— å†å²åŒ…è¢±

ç³»ç»Ÿç°åœ¨æ›´åŠ ç¨³å®šã€çµæ´»å’Œå¯æ‰©å±•ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘æä¾›äº†åšå®çš„åŸºç¡€ã€‚ 