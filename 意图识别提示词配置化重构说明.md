# 意图识别提示词配置化重构说明

## 概述

本次重构将意图识别LLM的提示词从代码中完全提取到配置文件中，实现了提示词的配置化管理，方便后续扩展和维护。

## 主要改进

### 1. 配置文件化

#### 新增文件
- `prompts/intent_analysis_prompts.yaml` - 意图识别配置文件
- `app/services/intent_prompt_service.py` - 意图提示词服务
- `app/routes/intent_routes.py` - 意图配置管理API
- `app/static/intent_config_test.html` - 配置管理测试页面

#### 配置结构
```yaml
# 核心意图识别配置
intent_analysis:
  system_prompt: |
    详细的系统提示词...
  user_prompt_template: |
    用户提示词模板...
  parameters:
    max_tokens: 300
    temperature: 0.1
    confidence_threshold: 0.6

# 场景化提示词
scenario_prompts:
  legal_document:
    system_prompt: |
      法律文档专用提示词...
    enhanced_keywords:
      search: ["法条", "条款", "法规"]
      
# 置信度调整规则
confidence_rules:
  high_confidence:
    - condition: "包含明确的文件扩展名"
      boost: 0.2
      intent_type: "mcp_action"
```

### 2. 服务层重构

#### IntentPromptService 类
```python
class IntentPromptService:
    def get_system_prompt(self, scenario=None)  # 获取系统提示词
    def get_user_prompt_template()              # 获取用户提示词模板
    def get_model_parameters()                  # 获取模型参数
    def get_confidence_boost(query, intent)     # 置信度调整
    def analyze_query_complexity(query)        # 查询复杂度分析
    def reload_config()                         # 重载配置
```

#### LLMService 更新
- 集成 IntentPromptService
- 支持场景化提示词
- 智能置信度调整
- 更完善的错误处理

### 3. API接口扩展

#### 新增路由 `/api/intent/`
- `GET /config` - 获取配置概览
- `GET /scenarios` - 获取可用场景
- `POST /test` - 单次意图识别测试
- `POST /batch-test` - 批量意图识别测试
- `GET /prompt` - 获取提示词模板
- `POST /reload` - 重载配置文件

### 4. 功能增强

#### 场景化支持
```python
# 支持特定场景的意图识别
intent_result = LLMService.analyze_user_intent(
    query="查找财务报表", 
    scenario="financial_document"
)
```

#### 动态置信度调整
```python
# 根据配置规则自动调整置信度
confidence_boost = intent_prompt_service.get_confidence_boost(
    query, intent_type
)
```

#### 查询复杂度分析
```python
# 分析查询的语言特征
features = intent_prompt_service.analyze_query_complexity(query)
```

## 配置管理

### 1. 提示词管理

#### 系统提示词
- 核心意图分类逻辑
- JSON输出格式要求
- 意图类型定义
- 置信度要求

#### 用户提示词模板
- 简洁的输入格式
- 变量占位符 `{query}`
- 输出要求

#### 场景化提示词
- 法律文档场景
- 财务文档场景
- HR文档场景
- 可扩展新场景

### 2. 参数配置

#### 模型参数
```yaml
parameters:
  max_tokens: 300      # 最大令牌数
  temperature: 0.1     # 温度设置
  confidence_threshold: 0.6  # 置信度阈值
```

#### 置信度规则
```yaml
confidence_rules:
  high_confidence:
    - condition: "包含明确的文件扩展名"
      boost: 0.2
      intent_type: "mcp_action"
```

### 3. 关键词增强

#### 动作动词映射
```yaml
action_verbs:
  create: ["创建", "新建", "建立", "生成"]
  search: ["搜索", "查找", "寻找", "检索"]
  analyze: ["分析", "检查", "审查", "评估"]
```

#### 对象名词映射
```yaml
object_nouns:
  file: ["文件", "文档", "资料", "材料"]
  folder: ["文件夹", "目录", "分类", "归档"]
```

## 使用指南

### 1. 基础使用

```python
# 使用默认配置
intent_result = LLMService.analyze_user_intent("创建新文件夹")

# 使用特定场景
intent_result = LLMService.analyze_user_intent(
    "查找合同条款", 
    scenario="legal_document"
)
```

### 2. 配置自定义

#### 修改提示词
1. 编辑 `prompts/intent_analysis_prompts.yaml`
2. 修改 `system_prompt` 或添加新场景
3. 调用 `POST /api/intent/reload` 重载配置

#### 添加新场景
```yaml
scenario_prompts:
  medical_document:
    system_prompt: |
      你是医疗文档管理专家...
    enhanced_keywords:
      search: ["病历", "诊断", "治疗", "药物"]
```

#### 调整置信度规则
```yaml
confidence_rules:
  high_confidence:
    - condition: "包含医疗术语"
      boost: 0.3
      intent_type: "vector_search"
```

### 3. 测试和调试

#### 访问测试页面
```
http://localhost:5001/intent_config_test.html
```

#### API测试
```bash
# 单次测试
curl -X POST http://localhost:5001/api/intent/test \
  -H "Content-Type: application/json" \
  -d '{"query": "创建新文件夹", "scenario": "general"}'

# 批量测试
curl -X POST http://localhost:5001/api/intent/batch-test \
  -H "Content-Type: application/json" \
  -d '{"queries": ["创建文件", "搜索报告", "分析数据"]}'
```

## 扩展指南

### 1. 添加新意图类型

#### 修改配置文件
```yaml
extended_intents:
  document_merge:
    description: "合并多个文档"
    keywords: ["合并", "整合", "组合文档"]
    confidence_boost: 0.1
```

#### 更新系统提示词
```yaml
intent_analysis:
  system_prompt: |
    意图分类说明：
    - document_merge: 文档合并操作
    ...
```

### 2. 场景扩展

#### 新增场景配置
```yaml
scenario_prompts:
  technical_document:
    system_prompt: |
      你是技术文档管理专家...
    enhanced_keywords:
      search: ["API", "接口", "函数", "代码"]
      analysis: ["性能", "架构", "设计模式"]
```

### 3. 规则增强

#### 复杂条件匹配
```python
def _match_condition(self, query: str, condition: str) -> bool:
    """自定义条件匹配逻辑"""
    if "包含技术术语" in condition:
        tech_terms = ["API", "SDK", "框架", "库"]
        return any(term in query for term in tech_terms)
    return False
```

## 兼容性和迁移

### 1. 向后兼容
- 保留原有 `config.py` 中的配置作为降级方案
- 原有调用方式继续有效
- 渐进式迁移支持

### 2. 迁移步骤
1. 部署新的配置文件和服务
2. 测试新配置的功能完整性
3. 逐步迁移使用新的API
4. 清理过时的硬编码配置

## 性能和监控

### 1. 性能优化
- 配置文件缓存
- 智能降级机制
- 批量处理支持

### 2. 监控指标
- 意图识别准确率
- 配置加载时间
- API响应时间
- 错误率统计

## 总结

本次重构实现了：

1. **配置化管理** - 提示词完全配置化，支持热重载
2. **场景化支持** - 不同业务场景的专门优化
3. **动态调整** - 智能置信度调整和查询分析
4. **易于扩展** - 新增意图类型和场景的简便流程
5. **测试友好** - 完整的测试API和管理界面
6. **向后兼容** - 平滑迁移和降级支持

这种设计使得意图识别功能更加灵活、可维护和可扩展，为后续的功能增强奠定了坚实的基础。 