# 智能检索助手相似度阈值功能

## 功能概述

为智能检索助手添加了用户可选择的相似度阈值功能，让用户可以根据需要调整搜索结果的相关性要求。

## 功能特点

### 1. 用户界面
- 在智能检索对话界面的右上角添加了相似度设置选择器
- 提供4个相关性等级选项：
  - **高相关性** (≥60%)
  - **中等相关性** (≥30%) - 默认选项
  - **低相关性** (≥10%)
  - **显示所有** (显示所有结果)

### 2. 后端实现
- 修改了 `BaseVectorizer.search_similar()` 方法，添加 `min_score` 参数
- 更新了搜索API路由，支持接收和处理 `similarity_level` 参数
- 根据用户选择的相关性等级自动设置相应的相似度阈值

### 3. 阈值映射
```python
similarity_thresholds = {
    'high': 0.6,      # 高相关性 (≥60%)
    'medium': 0.3,    # 中等相关性 (≥30%)
    'low': 0.1,       # 低相关性 (≥10%)
    'any': 0.0        # 显示所有结果
}
```

## 解决的问题

### 原问题
- 向量数据库中只有少量文档（9个向量实体）
- 搜索时强制返回固定数量结果（top_k=5）
- 即使完全不相关的内容也会被返回
- 用户无法控制搜索结果的相关性要求

### 解决方案
- 添加相似度阈值过滤，只返回达到最低相关性要求的结果
- 用户可以根据需要选择不同的相关性等级
- 当高相关性要求下没有结果时，系统会提示用户降低要求或使用其他关键词

## 使用示例

### API调用
```bash
curl -X POST http://localhost:5001/api/search/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "测试内容",
    "similarity_level": "high",
    "top_k": 5
  }'
```

### 返回结果
```json
{
  "success": true,
  "data": {
    "query": "测试内容",
    "similarity_level": "high",
    "min_score": 0.6,
    "total_results": 0,
    "results": []
  }
}
```

## 前端交互

### 用户体验
1. 用户在聊天界面输入查询内容
2. 选择期望的相关性等级（高/中/低/所有）
3. 发送查询，系统根据选择的等级过滤结果
4. 如果没有找到符合要求的结果，系统会给出友好的提示

### 智能提示
- 当高相关性要求下无结果时，系统会建议：
  1. 尝试使用其他关键词
  2. 降低相关性要求重新搜索
  3. 检查是否有相关文档已被向量化

## 技术实现

### 修改的文件
1. `app/services/vectorization/base_vectorizer.py` - 添加相似度阈值过滤
2. `app/routes/search_routes.py` - 支持相似度等级参数
3. `app/static/semantic_search.html` - 添加相似度选择器UI
4. `app/static/js/integrated_app.js` - 前端逻辑更新

### 核心逻辑
```python
# 后端过滤逻辑
for hits in results:
    for hit in hits:
        score = float(hit.score)
        if score >= min_score:  # 只返回达到阈值的结果
            similar_docs.append({
                "document_id": hit.entity.get("document_id"),
                "chunk_id": hit.entity.get("chunk_id"), 
                "text": hit.entity.get("text"),
                "score": score
            })
```

## 效果验证

通过测试验证了不同相似度等级的效果：
- **高相关性**: 严格筛选，只返回高度相关的结果
- **中等相关性**: 平衡相关性和结果数量
- **低相关性**: 包含更多可能相关的结果
- **显示所有**: 不过滤，显示所有搜索结果

这个功能有效解决了原来"搜索不相关内容也能检索到文件"的问题，让用户可以根据实际需要控制搜索结果的质量。 