# æœç´¢ç»“æœæ˜¾ç¤ºé—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ” **é—®é¢˜æè¿°**

æ ¹æ®ç”¨æˆ·æä¾›çš„æ—¥å¿—åˆ†æï¼Œå‘ç°äº†ä¸€ä¸ªé‡è¦çš„æœç´¢ç»“æœæ˜¾ç¤ºé—®é¢˜ï¼š

- **ç¬¬ä¸€æ¬¡æœç´¢**ï¼ˆè¯­ä¹‰æœç´¢ï¼‰ï¼šåªæ˜¾ç¤º"æ‰¾åˆ°äº†5ä¸ªç›¸å…³æ–‡ä»¶"ï¼Œä½†æ²¡æœ‰æ˜¾ç¤ºå…·ä½“æ–‡ä»¶åˆ—è¡¨å’Œè¶…é“¾æ¥
- **ç¬¬äºŒæ¬¡æœç´¢**ï¼ˆæ··åˆæœç´¢ï¼‰ï¼šæ­£å¸¸æ˜¾ç¤ºäº†æ–‡ä»¶åˆ—è¡¨ã€è¶…é“¾æ¥å’Œè¯¦ç»†ä¿¡æ¯

ä»æ—¥å¿—çœ‹ï¼Œä¸¤æ¬¡æœç´¢éƒ½æˆåŠŸæ‰¾åˆ°äº†5ä¸ªç»“æœï¼Œä½†æ˜¾ç¤ºæ•ˆæœæˆªç„¶ä¸åŒã€‚

## ğŸ“Š **æ ¹æœ¬åŸå› åˆ†æ**

### 1. **æ•°æ®ç»“æ„ä¸åŒ¹é…**

**è¯­ä¹‰æœç´¢è¿”å›çš„åŸå§‹æ ¼å¼ï¼š**
```python
# app/services/vectorization/base_vectorizer.py search_similar()
[
    {
        "document_id": "xxx",
        "chunk_id": "xxx", 
        "text": "xxx",
        "score": 0.8
    }
]
```

**å‰ç«¯æœŸæœ›çš„æ ¼å¼ï¼š**
```javascript
// app/static/js/integrated_app.js formatFileSearchResults()
data.results.forEach(result => {
    const docId = result.document ? result.document.id : result.id;  // âŒ æœŸæœ›æœ‰documentå­—æ®µ
    document: result.document || result,  // âŒ æœŸæœ›å®Œæ•´çš„documentå¯¹è±¡
})
```

**æ··åˆæœç´¢è¿”å›çš„æ ¼å¼ï¼š**
```python
# æ··åˆæœç´¢ç»è¿‡aggregate_results_by_file()å¤„ç†åè¿”å›file_results
data.file_results = [
    {
        document: {...},  # âœ… åŒ…å«å®Œæ•´çš„documentå¯¹è±¡
        chunks: [...],
        score: 0.8
    }
]
```

### 2. **å‰ç«¯å¤„ç†é€»è¾‘å·®å¼‚**

å‰ç«¯çš„`formatFileSearchResults()`å‡½æ•°æœ‰ä¸¤å¥—å¤„ç†é€»è¾‘ï¼š

```javascript
if (data.file_results) {
    // æ··åˆæœç´¢ï¼šç›´æ¥ä½¿ç”¨ âœ…
    fileResults = data.file_results;
} else if (data.results && Array.isArray(data.results)) {
    // è¯­ä¹‰æœç´¢ï¼šéœ€è¦è½¬æ¢æ ¼å¼ âŒ è½¬æ¢å¤±è´¥
    const documentMap = {};
    data.results.forEach(result => {
        const docId = result.document ? result.document.id : result.id;  // è·å–ä¸åˆ°document.id
        // ... åç»­å¤„ç†å¤±è´¥
    });
}
```

### 3. **é—®é¢˜é“¾æ¡**

```
è¯­ä¹‰æœç´¢ â†’ ç¼ºå°‘documentå¯¹è±¡ â†’ å‰ç«¯è½¬æ¢å¤±è´¥ â†’ fileResultsä¸ºç©º â†’ åªæ˜¾ç¤ºæ•°é‡ä¸æ˜¾ç¤ºåˆ—è¡¨
æ··åˆæœç´¢ â†’ åŒ…å«documentå¯¹è±¡ â†’ å‰ç«¯ç›´æ¥ä½¿ç”¨ â†’ æ­£å¸¸æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
```

## ğŸ› ï¸ **è§£å†³æ–¹æ¡ˆ**

### ä¿®å¤è¯­ä¹‰æœç´¢çš„æ•°æ®ç»“æ„

åœ¨ `app/routes/search_routes.py` çš„è¯­ä¹‰æœç´¢éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ·»åŠ äº†æ•°æ®è¡¥å……é€»è¾‘ï¼š

```python
# ä¿®å¤å‰ï¼šç›´æ¥è¿”å›åŸå§‹ç»“æœ
search_results = vector_service.search_similar(...)

# ä¿®å¤åï¼šè¡¥å……å®Œæ•´çš„æ–‡æ¡£ä¿¡æ¯
raw_results = vector_service.search_similar(...)
search_results = []
for result in raw_results:
    document_id = result.get('document_id')
    if document_id:
        document = DocumentNode.query.get(document_id)
        if document and not document.is_deleted:
            enriched_result = {
                'id': result.get('chunk_id', ''),
                'document_id': document_id,
                'chunk_id': result.get('chunk_id', ''),
                'text': result.get('text', ''),
                'score': result.get('score', 0),
                'document': {  # âœ… æ·»åŠ å®Œæ•´çš„documentå¯¹è±¡
                    'id': document.id,
                    'name': document.name,
                    'file_type': document.file_type,
                    'file_size': document.file_size,
                    'created_at': document.created_at.isoformat() if document.created_at else None,
                    'description': document.description
                }
            }
            search_results.append(enriched_result)
```

### æ ¸å¿ƒæ”¹è¿›ç‚¹

1. **æ•°æ®è¡¥å……**ï¼šä¸ºæ¯ä¸ªæœç´¢ç»“æœæ·»åŠ å®Œæ•´çš„`document`å¯¹è±¡
2. **æ ¼å¼ç»Ÿä¸€**ï¼šç¡®ä¿è¯­ä¹‰æœç´¢è¿”å›çš„æ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸€è‡´
3. **å‘åå…¼å®¹**ï¼šä¸å½±å“æ··åˆæœç´¢çš„ç°æœ‰åŠŸèƒ½
4. **é”™è¯¯å¤„ç†**ï¼šè¿‡æ»¤å·²åˆ é™¤çš„æ–‡æ¡£ï¼Œç¡®ä¿ç»“æœæœ‰æ•ˆæ€§

## ğŸ“ˆ **ä¿®å¤æ•ˆæœå¯¹æ¯”**

### ä¿®å¤å‰

**è¯­ä¹‰æœç´¢å“åº”ï¼š**
```json
{
  "success": true,
  "data": {
    "query": "æ‰¾åˆ°å’Œæ›¾å‹‡ç›¸å…³çš„æ‰€æœ‰å†…å®¹",
    "results": [
      {
        "document_id": "xxx",  // âŒ åªæœ‰IDï¼Œæ²¡æœ‰documentå¯¹è±¡
        "chunk_id": "xxx",
        "text": "xxx",
        "score": 0.8
      }
    ],
    "total_results": 5
  }
}
```

**å‰ç«¯æ˜¾ç¤ºï¼š** 
- âŒ åªæ˜¾ç¤º"æ‰¾åˆ°äº†5ä¸ªç›¸å…³æ–‡ä»¶"
- âŒ æ²¡æœ‰æ–‡ä»¶åˆ—è¡¨
- âŒ æ²¡æœ‰è¶…é“¾æ¥

### ä¿®å¤å

**è¯­ä¹‰æœç´¢å“åº”ï¼š**
```json
{
  "success": true, 
  "data": {
    "query": "æ‰¾åˆ°å’Œæ›¾å‹‡ç›¸å…³çš„æ‰€æœ‰å†…å®¹",
    "results": [
      {
        "document_id": "xxx",
        "chunk_id": "xxx",
        "text": "xxx", 
        "score": 0.8,
        "document": {  // âœ… åŒ…å«å®Œæ•´çš„documentå¯¹è±¡
          "id": "xxx",
          "name": "æ–‡æ¡£å.pdf",
          "file_type": "pdf",
          "file_size": 1024,
          "created_at": "2025-06-10T15:27:52",
          "description": "æ–‡æ¡£æè¿°"
        }
      }
    ],
    "total_results": 5,
    "min_score": 0.15
  }
}
```

**å‰ç«¯æ˜¾ç¤ºï¼š**
- âœ… æ˜¾ç¤º"æ‰¾åˆ°äº†5ä¸ªç›¸å…³æ–‡ä»¶"
- âœ… æ˜¾ç¤ºå®Œæ•´çš„æ–‡ä»¶åˆ—è¡¨  
- âœ… æ–‡ä»¶åæœ‰ç‚¹å‡»è¶…é“¾æ¥
- âœ… æ˜¾ç¤ºæ–‡ä»¶ç±»å‹ã€åŒ¹é…åº¦ã€å†…å®¹æ‘˜è¦
- âœ… ä¸æ··åˆæœç´¢æ˜¾ç¤ºæ•ˆæœä¸€è‡´

## ğŸ”§ **å…¶ä»–ä¼˜åŒ–**

### 1. æ·»åŠ ç›¸ä¼¼åº¦é˜ˆå€¼

```python
# è®¾ç½®åˆç†çš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé¿å…è¿”å›å¤ªå¤šä½è´¨é‡ç»“æœï¼‰
min_score = 0.2  # è¯­ä¹‰æœç´¢çš„é»˜è®¤æœ€ä½ç›¸ä¼¼åº¦é˜ˆå€¼

# å¯¹äººåç­‰ä¸“æœ‰åè¯æŸ¥è¯¢é€‚å½“é™ä½é˜ˆå€¼
if len(search_query.strip().split()) <= 2 and not any(word in search_query.lower() for word in ['åˆ›å»º', 'æ–°å»º', 'å¸®æˆ‘', 'æ‰¾åˆ°', 'æœç´¢']):
    min_score = 0.15  # ç®€çŸ­æŸ¥è¯¢ï¼ˆå¦‚äººåï¼‰é™ä½é˜ˆå€¼
```

### 2. å“åº”æ•°æ®å¢å¼º

```python
# æ·»åŠ æœç´¢é…ç½®ä¿¡æ¯
if not skip_search and 'min_score' in locals():
    data['min_score'] = min_score
```

## ğŸ¯ **æµ‹è¯•éªŒè¯**

ä¿®å¤åï¼Œä¸¤ç§æœç´¢æ–¹å¼éƒ½åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºï¼š

### è¯­ä¹‰æœç´¢æµ‹è¯•
```bash
POST /api/search/
{
  "query": "æ‰¾åˆ°å’Œæ›¾å‹‡ç›¸å…³çš„æ‰€æœ‰å†…å®¹",
  "llm_model": "deepseek:deepseek-chat",
  "enable_mcp": true
}
```

### æ··åˆæœç´¢æµ‹è¯•
```bash
POST /api/search/hybrid
{
  "query": "æ›¾å‹‡", 
  "llm_model": "deepseek:deepseek-chat",
  "enable_llm": true,
  "enable_mcp": true,
  "similarity_level": "medium"
}
```

ä¸¤ç§æœç´¢éƒ½åº”è¯¥è¿”å›ï¼š
- âœ… æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
- âœ… å¯ç‚¹å‡»çš„æ–‡ä»¶åè¶…é“¾æ¥
- âœ… ç›¸ä¼¼åº¦åˆ†æ•°
- âœ… å†…å®¹æ‘˜è¦
- âœ… æ–‡ä»¶ç±»å‹ä¿¡æ¯

## ğŸ“ **ç»éªŒæ€»ç»“**

### å‘ç°çš„é—®é¢˜æ¨¡å¼

1. **å‰åç«¯æ•°æ®å¥‘çº¦ä¸ä¸€è‡´**ï¼šåç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸åŒ¹é…
2. **åŠŸèƒ½å­¤ç«‹å¼€å‘**ï¼šè¯­ä¹‰æœç´¢å’Œæ··åˆæœç´¢åˆ†åˆ«å¼€å‘ï¼Œæ•°æ®æ ¼å¼ä¸ç»Ÿä¸€
3. **ç¼ºå°‘ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šè™½ç„¶åç«¯è¿”å›äº†æ•°æ®ï¼Œä½†å‰ç«¯å±•ç¤ºå¤±è´¥

### æœ€ä½³å®è·µå»ºè®®

1. **ç»Ÿä¸€æ•°æ®æ ¼å¼**ï¼šç¡®ä¿åŒç±»åŠŸèƒ½è¿”å›ä¸€è‡´çš„æ•°æ®ç»“æ„
2. **å‰ç«¯é€‚é…æ€§**ï¼šå‰ç«¯åº”è¯¥èƒ½å¤Ÿå¤„ç†ä¸åŒæ¥æºçš„æ•°æ®æ ¼å¼
3. **å®Œæ•´æµ‹è¯•**ï¼šä¸ä»…æµ‹è¯•APIè¿”å›ï¼Œè¿˜è¦æµ‹è¯•å‰ç«¯å±•ç¤ºæ•ˆæœ
4. **é”™è¯¯ç›‘æ§**ï¼šæ·»åŠ å‰ç«¯æ•°æ®å¤„ç†çš„é”™è¯¯æ—¥å¿—

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œè¯­ä¹‰æœç´¢ç°åœ¨èƒ½å¤Ÿä¸æ··åˆæœç´¢æä¾›ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒï¼Œè§£å†³äº†"æ‰¾åˆ°ç»“æœä½†ä¸æ˜¾ç¤º"çš„é—®é¢˜ï¼ğŸ‰ 